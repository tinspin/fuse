<!DOCTYPE HTML>
<html>
<head>
<style>
  div { font-family: monospace; margin: 3px; }
  input { font-family: monospace; }
  #pushpull {
    position: fixed;
    bottom: 0px;
    left: 0px;
  }
</style>
<script src="md5.js"></script>
<script>
  var size = 0;
  var name = '';
  function pull() {
    send('pull', name, null);
  }
  function push(data) {
    return send('push', name, data);
  }
  function send(path, name, data) {
    var state = (path == 'pull' ? 3 : 4);
    var xhr = new XMLHttpRequest();
    var url = 'http://fuse.rupy.se/' + path + '?name=' + name + '&data=' + encodeURIComponent(data);
    xhr.open('GET', url, state == 3); // sync is deprecated really? genious!
    xhr.setRequestHeader('Accept', 'text/event-stream');
    if(state == 3) {
      xhr.onreadystatechange = function() {
        if(xhr.readyState == 3) {
          event(path, xhr.responseText.substring(size, xhr.responseText.length));
          size = xhr.responseText.length;
        }
      };
    }
    xhr.send();
    if(state == 4) {
      event(path, xhr.responseText);
      return xhr.responseText;
    }
  }
  function event(path, data) {
    var body = data;
  
    if(path == 'pull')
      body = data.substring(5, data.length - 2);
    else
      body += '\n';
  
    document.getElementById(path).innerHTML += body;
  }
</script>
<script>
  function register() {
    name = id('name');
    var pass = id('pass');
    if(pass.length < 3)
      return;
    var hash = md5(pass + name);
    var join = push('join|' + hash).split('|');
    //if(join[1] == 'fail')
    if(join[1] == 'done') {
      authorize();
    }
  }
  function login() {
    name = id('name');
    var pass = id('pass');
    var salt = push('salt').split('|');
    if(salt[1] === 'fail')
      return;
    var hash = md5(md5(pass + name) + salt[2]);
    var user = push('user|' + salt[2] + '|' + hash).split('|');
    //if(user[1] == 'fail')
    if(user[1] == 'done') {
      authorize();
    }
  }
  function authorize() {
    display('user', 'none');
    display('join', 'block');
    pull();
  }
  function none(data) {
    send('push', name, data);
  }
  function id(name, reset) {
    var value = document.getElementById(name).value;
    if(reset)
      document.getElementById(name).value = '';
    return value;
  }
  function display(id, value) {
    document.getElementById(id).style.display = value;
  }
  function login_key(e) {
    e = e || window.event;
    var unicode = e.charCode ? e.charCode : e.keyCode ? e.keyCode : 0;
    if(unicode == 13) {
      login();
    }
  }
  function chat_key(e) {
    e = e || window.event;
    var unicode = e.charCode ? e.charCode : e.keyCode ? e.keyCode : 0;
    if(unicode == 13) {
      chat();
    }
  }
  function chat() {
    none('chat|' + id('chat', true));
  }
</script>
</head>
<body>

<div id="user"><table>
<tr><td>name&nbsp;</td><td><input id="name" size="10"></td></tr>
<tr><td>pass&nbsp;</td><td><input id="pass" type="password" size="10" onkeypress="login_key(event);"></td></tr>
<tr><td><a href="javascript:register();">join</a></td><td align="right"><a href="javascript:login();">login</a></td></tr>
</table>
</div>

<div id="join" style="display: none;">
text&nbsp;<input id="chat" size="10" onkeypress="chat_key(event);">
<a href="javascript:chat();">chat</a>
<a href="javascript:none('list|room');">list</a>
<a href="javascript:none('room|two');">room</a>
<a href="javascript:none('exit');">exit</a>
</div>

<div>
<img src="svg/blue.svg"><br>
<img src="svg/green.svg"><br>
<img src="svg/orange.svg"><br>
<img src="svg/purple.svg"><br>
<img src="svg/red.svg">
</div>

<div id="pushpull">
<div id="pull">pull:</div>
<div id="push">push:</div>
</div>

</body>
</html>